<div class="checkout" *ngIf="cartItems.length > 0">
  <div class="checkout-container">
    <!-- Header -->
    <div class="checkout-header">
      <button mat-icon-button (click)="goBackToCart()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h1>Finalizar Pedido</h1>
    </div>

    <div class="checkout-content">
      <!-- Stepper -->
      <mat-stepper #stepper linear class="checkout-stepper">
        <!-- Step 1: Delivery Information -->
        <mat-step [stepControl]="deliveryForm" label="Información de Entrega">
          <form [formGroup]="deliveryForm" class="step-form">
            <div class="form-section">
              <h3>
                <mat-icon>location_on</mat-icon>
                Datos de Entrega
              </h3>
              
              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Nombre completo</mat-label>
                  <input matInput formControlName="fullName" placeholder="Ej: Juan Pérez">
                  <mat-icon matSuffix>person</mat-icon>
                  <mat-error *ngIf="deliveryForm.get('fullName')?.hasError('required')">
                    El nombre es requerido
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Teléfono</mat-label>
                  <input matInput formControlName="phone" placeholder="987654321" maxlength="9">
                  <mat-icon matSuffix>phone</mat-icon>
                  <mat-error *ngIf="deliveryForm.get('phone')?.hasError('required')">
                    El teléfono es requerido
                  </mat-error>
                  <mat-error *ngIf="deliveryForm.get('phone')?.hasError('pattern')">
                    Ingresa un teléfono válido (9 dígitos)
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Distrito</mat-label>
                  <mat-select formControlName="district">
                    <mat-option value="lima">Lima</mat-option>
                    <mat-option value="miraflores">Miraflores</mat-option>
                    <mat-option value="san-isidro">San Isidro</mat-option>
                    <mat-option value="surco">Surco</mat-option>
                    <mat-option value="la-molina">La Molina</mat-option>
                    <mat-option value="san-borja">San Borja</mat-option>
                  </mat-select>
                  <mat-error *ngIf="deliveryForm.get('district')?.hasError('required')">
                    Selecciona un distrito
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Dirección completa</mat-label>
                  <textarea matInput formControlName="address" rows="2" 
                            placeholder="Ej: Av. Larco 123, Dpto 4B"></textarea>
                  <mat-icon matSuffix>home</mat-icon>
                  <mat-error *ngIf="deliveryForm.get('address')?.hasError('required')">
                    La dirección es requerida
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Referencia (opcional)</mat-label>
                  <input matInput formControlName="reference" 
                         placeholder="Ej: Frente al parque, casa azul">
                  <mat-icon matSuffix>place</mat-icon>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Notas adicionales (opcional)</mat-label>
                  <textarea matInput formControlName="notes" rows="2" 
                            placeholder="Instrucciones especiales para el delivery"></textarea>
                  <mat-icon matSuffix>note</mat-icon>
                </mat-form-field>
              </div>
            </div>

            <div class="step-actions">
              <button mat-raised-button color="primary" matStepperNext 
                      [disabled]="deliveryForm.invalid">
                Continuar
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </form>
        </mat-step>

        <!-- Step 2: Payment Method -->
        <mat-step [stepControl]="paymentForm" label="Método de Pago">
          <form [formGroup]="paymentForm" class="step-form">
            <div class="form-section">
              <h3>
                <mat-icon>payment</mat-icon>
                Selecciona tu método de pago
              </h3>

              <mat-radio-group formControlName="method" class="payment-methods">
                <div *ngFor="let method of paymentMethods" class="payment-method">
                  <mat-radio-button [value]="method.value" class="payment-radio">
                    <div class="payment-option">
                      <mat-icon>{{ method.icon }}</mat-icon>
                      <span>{{ method.label }}</span>
                    </div>
                  </mat-radio-button>
                </div>
              </mat-radio-group>

              <!-- Card Payment Fields -->
              <div *ngIf="paymentForm.get('method')?.value === 'card'" class="payment-details">
                <h4>Datos de la Tarjeta</h4>
                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Número de tarjeta</mat-label>
                    <input matInput formControlName="cardNumber" placeholder="1234 5678 9012 3456" 
                           maxlength="16">
                    <mat-icon matSuffix>credit_card</mat-icon>
                  </mat-form-field>
                </div>
                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Nombre en la tarjeta</mat-label>
                    <input matInput formControlName="cardName" placeholder="JUAN PEREZ">
                    <mat-icon matSuffix>person</mat-icon>
                  </mat-form-field>
                </div>
                <div class="form-row">
                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>Fecha de vencimiento</mat-label>
                    <input matInput formControlName="cardExpiry" placeholder="MM/YY" maxlength="5">
                    <mat-icon matSuffix>date_range</mat-icon>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>CVV</mat-label>
                    <input matInput formControlName="cardCvv" placeholder="123" maxlength="4" type="password">
                    <mat-icon matSuffix>security</mat-icon>
                  </mat-form-field>
                </div>
              </div>

              <!-- Yape Payment Fields -->
              <div *ngIf="paymentForm.get('method')?.value === 'yape'" class="payment-details">
                <h4>Pago con Yape</h4>
                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Número de teléfono Yape</mat-label>
                    <input matInput formControlName="yapePhone" placeholder="987654321" maxlength="9">
                    <mat-icon matSuffix>phone_android</mat-icon>
                  </mat-form-field>
                </div>
                <div class="yape-info">
                  <mat-icon>info</mat-icon>
                  <p>Te enviaremos una notificación para completar el pago con Yape</p>
                </div>
              </div>

              <!-- Plin Payment Fields -->
              <div *ngIf="paymentForm.get('method')?.value === 'plin'" class="payment-details">
                <h4>Pago con Plin</h4>
                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Número de teléfono Plin</mat-label>
                    <input matInput formControlName="plinPhone" placeholder="987654321" maxlength="9">
                    <mat-icon matSuffix>account_balance_wallet</mat-icon>
                  </mat-form-field>
                </div>
                <div class="plin-info">
                  <mat-icon>info</mat-icon>
                  <p>Te enviaremos una notificación para completar el pago con Plin</p>
                </div>
              </div>

              <!-- Cash Payment Info -->
              <div *ngIf="paymentForm.get('method')?.value === 'cash'" class="payment-details">
                <div class="cash-info">
                  <mat-icon>payments</mat-icon>
                  <div>
                    <h4>Pago en Efectivo</h4>
                    <p>Pagarás al momento de recibir tu pedido. Asegúrate de tener el monto exacto.</p>
                    <p><strong>Total a pagar: S/{{ total.toFixed(2) }}</strong></p>
                  </div>
                </div>
              </div>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_back</mat-icon>
                Atrás
              </button>
              <button mat-raised-button color="primary" matStepperNext 
                      [disabled]="paymentForm.invalid">
                Continuar
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </form>
        </mat-step>

        <!-- Step 3: Order Review -->
        <mat-step label="Confirmar Pedido">
          <div class="order-review">
            <h3>
              <mat-icon>receipt</mat-icon>
              Resumen del Pedido
            </h3>

            <!-- Order Items -->
            <div class="order-items">
              <div *ngFor="let item of cartItems" class="order-item">
                <img [src]="item.product.image" [alt]="item.product.name" class="item-image">
                <div class="item-details">
                  <h4>{{ item.product.name }}</h4>
                  <p>Cantidad: {{ item.quantity }}</p>
                  <p *ngIf="item.notes" class="item-notes">{{ item.notes }}</p>
                </div>
                <div class="item-price">
                  S/{{ (item.product.price * item.quantity).toFixed(2) }}
                </div>
              </div>
            </div>

            <mat-divider></mat-divider>

            <!-- Order Summary -->
            <div class="order-summary">
              <div class="summary-row">
                <span>Subtotal</span>
                <span>S/{{ subtotal.toFixed(2) }}</span>
              </div>
              <div class="summary-row">
                <span>Costo de envío</span>
                <span>S/{{ deliveryFee.toFixed(2) }}</span>
              </div>
              <div class="summary-row total-row">
                <span>Total</span>
                <span>S/{{ total.toFixed(2) }}</span>
              </div>
            </div>

            <mat-divider></mat-divider>

            <!-- Delivery Info -->
            <div class="delivery-info">
              <h4>Información de Entrega</h4>
              <p><strong>{{ deliveryForm.value.fullName }}</strong></p>
              <p>{{ deliveryForm.value.phone }}</p>
              <p>{{ getFullAddress() }}</p>
              <p><strong>Método de pago:</strong> {{ getPaymentMethodLabel() }}</p>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_back</mat-icon>
                Atrás
              </button>
              <button mat-raised-button 
                      color="primary" 
                      (click)="processOrder()"
                      [disabled]="isProcessing"
                      class="confirm-button">
                <mat-spinner *ngIf="isProcessing" diameter="20"></mat-spinner>
                <mat-icon *ngIf="!isProcessing">check_circle</mat-icon>
                {{ isProcessing ? 'Procesando...' : 'Confirmar Pedido' }}
              </button>
            </div>
          </div>
        </mat-step>
      </mat-stepper>
    </div>
  </div>
</div>

<!-- Empty Cart Message -->
<div *ngIf="cartItems.length === 0" class="empty-checkout">
  <mat-icon class="empty-icon">shopping_cart</mat-icon>
  <h2>Tu carrito está vacío</h2>
  <p>Agrega algunos productos antes de proceder al checkout</p>
  <button mat-raised-button color="primary" routerLink="/customer/menu">
    <mat-icon>restaurant_menu</mat-icon>
    Ver Menú
  </button>
</div>